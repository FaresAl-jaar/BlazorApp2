@page "/history"
@using BlazorApp2.Models
@using BlazorApp2.Models.DTOs
@using BlazorApp2.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDocumentService DocumentService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Dokumenten-Historie</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-clock-history me-2"></i>Dokumenten-Historie</h2>
            <p class="text-muted">Übersicht aller verarbeiteten und übermittelten Dokumente</p>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Von:</label>
            <input type="date" class="form-control" @bind="dateFrom" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Bis:</label>
            <input type="date" class="form-control" @bind="dateTo" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Status:</label>
            <select class="form-select" @bind="selectedStatus">
                <option value="">Alle</option>
                <option value="Submitted">Übermittelt</option>
                <option value="Reviewed">Geprüft</option>
            </select>
        </div>
        <div class="col-md-3 align-self-end">
            <button class="btn btn-primary" @onclick="LoadHistory">
                <i class="bi bi-search me-1"></i>Suchen
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Laden...</span>
            </div>
        </div>
    }
    else if (documents == null || documents.Count == 0)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>Keine historischen Dokumente gefunden.
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <strong>@documents.Count</strong> Dokumente gefunden
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Externe ID</th>
                            <th>Dateiname</th>
                            <th>Empfangen</th>
                            <th>Status</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var doc in documents)
                        {
                            <tr>
                                <td>@doc.Id</td>
                                <td><code>@doc.ExternalId</code></td>
                                <td>@doc.FileName</td>
                                <td>@doc.ReceivedAt.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(doc.Status)">
                                        @GetStatusDisplayName(doc.Status)
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDocument(doc.Id)">
                                        <i class="bi bi-eye"></i> Ansehen
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<DocumentListItemDto>? documents;
    private DateTime? dateFrom;
    private DateTime? dateTo;
    private string selectedStatus = string.Empty;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        dateTo = DateTime.Today;
        dateFrom = DateTime.Today.AddMonths(-1);
        await LoadHistory();
    }

    private async Task LoadHistory()
    {
        isLoading = true;
        
        DocumentStatus? statusFilter = null;
        if (!string.IsNullOrEmpty(selectedStatus) && Enum.TryParse<DocumentStatus>(selectedStatus, out var parsed))
        {
            statusFilter = parsed;
        }

        var allDocs = await DocumentService.GetDocumentsAsync(statusFilter);
        
        documents = allDocs
            .Where(d => d.Status == DocumentStatus.Submitted || d.Status == DocumentStatus.Reviewed)
            .Where(d => !dateFrom.HasValue || d.ReceivedAt >= dateFrom.Value)
            .Where(d => !dateTo.HasValue || d.ReceivedAt <= dateTo.Value.AddDays(1))
            .OrderByDescending(d => d.ReceivedAt)
            .ToList();

        isLoading = false;
    }

    private void ViewDocument(int id)
    {
        Navigation.NavigateTo($"/document/{id}");
    }

    private string GetStatusDisplayName(DocumentStatus status) => status switch
    {
        DocumentStatus.Reviewed => "Geprüft",
        DocumentStatus.Submitted => "Übermittelt",
        _ => status.ToString()
    };

    private string GetStatusBadgeClass(DocumentStatus status) => status switch
    {
        DocumentStatus.Reviewed => "bg-success",
        DocumentStatus.Submitted => "bg-primary",
        _ => "bg-secondary"
    };
}
