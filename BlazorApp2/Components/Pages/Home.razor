@page "/"
@using BlazorApp2.Models
@using BlazorApp2.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDocumentService DocumentService
@inject IServiceScopeFactory ScopeFactory
@inject NavigationManager NavigationManager
@implements IDisposable
@rendermode InteractiveServer

<PageTitle>Dashboard - PDF Manager</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-speedometer2 me-2"></i>Dashboard</h2>
            <p class="dashboard-subtitle">
                Übersicht über den Dokumentenstatus
                @if (autoRefreshEnabled)
                {
                    <span class="badge bg-success ms-2"><i class="bi bi-broadcast me-1"></i>Auto-Refresh aktiv</span>
                }
            </p>
        </div>
        <div class="col-auto">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh" @bind="autoRefreshEnabled" @bind:after="OnAutoRefreshChanged" />
                <label class="form-check-label" for="autoRefresh">Auto-Aktualisierung</label>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(notification))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-bell me-2"></i>@notification
            <button type="button" class="btn-close" @onclick="() => notification = null"></button>
        </div>
    }

    @* Status Cards Row *@
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@receivedCount</h4>
                            <p class="mb-0">Empfangen</p>
                        </div>
                        <i class="bi bi-inbox fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@pendingCount</h4>
                            <p class="mb-0">Zur Prüfung</p>
                        </div>
                        <i class="bi bi-hourglass-split fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@reviewedCount</h4>
                            <p class="mb-0">Geprüft</p>
                        </div>
                        <i class="bi bi-check-circle fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@submittedCount</h4>
                            <p class="mb-0">Übermittelt</p>
                        </div>
                        <i class="bi bi-send-check fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* Documents and System Info Row - Improved Layout *@
    <div class="row g-4 mb-4">
        <div class="col-xl-7 col-lg-12">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-bottom-0 pt-3">
                    <h5 class="card-title mb-0"><i class="bi bi-clock me-2 text-primary"></i>Neueste Dokumente</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        @if (recentDocuments != null && recentDocuments.Any())
                        {
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-3">Dateiname</th>
                                        <th>Datum</th>
                                        <th class="pe-3">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var doc in recentDocuments.Take(6))
                                    {
                                        <tr>
                                            <td class="ps-3 text-truncate" style="max-width: 250px;">
                                                <a href="/documents" class="text-decoration-none text-dark fw-medium">@doc.FileName</a>
                                            </td>
                                            <td>@doc.ReceivedAt.ToString("dd.MM.yy HH:mm")</td>
                                            <td class="pe-3"><span class="badge rounded-pill @GetStatusBadgeClass(doc.Status)">@GetStatusDisplayName(doc.Status)</span></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-inbox fs-2 d-block mb-2"></i>
                                Keine Dokumente vorhanden.
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-5 col-lg-12">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white border-bottom-0 pt-3">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle me-2 text-info"></i>System-Information</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                            <span class="text-muted">Anwendung</span>
                            <span class="fw-bold text-primary">PDF-Manager v1.1</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                            <span class="text-muted">Server-Zeit</span>
                            <span>@DateTime.Now.ToString("dd.MM.yyyy HH:mm:ss")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                            <span class="text-muted">Datenbank</span>
                            <span class="badge bg-success-subtle text-success border border-success-subtle">Aktiv</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0 px-0">
                            <span class="text-muted">Lobster API</span>
                            <div>
                                @if (isCheckingApi)
                                {
                                    <span class="spinner-border spinner-border-sm text-secondary"></span>
                                }
                                else if (apiConnected)
                                {
                                    <span class="badge bg-success-subtle text-success border border-success-subtle"><i class="bi bi-check-circle me-1"></i>Verbunden</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle"><i class="bi bi-x-circle me-1"></i>Nicht erreichbar</span>
                                }
                                <button class="btn btn-sm btn-light ms-2 rounded-circle" @onclick="CheckApiConnection" title="Verbindung prüfen">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </li>
                    </ul>
                    
                    <div class="mt-4 p-3 bg-light rounded-3">
                        <small class="text-muted d-block mb-1">OCR Konfiguration</small>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark-code fs-4 me-2 text-secondary"></i>
                            <span class="small font-monospace text-truncate">ocr_config.json</span>
                            <a href="/admin/ocr-config" class="btn btn-sm btn-outline-primary ms-auto">Bearbeiten</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@code {
    private int receivedCount;
    private int pendingCount;
    private bool apiConnected;
    private bool isCheckingApi;
    private int reviewedCount;
    private int submittedCount;
    private int lastDocumentCount;
    private List<BlazorApp2.Models.DTOs.DocumentListItemDto>? recentDocuments;
    private string? notification;
    private bool autoRefreshEnabled = true;
    private System.Threading.Timer? refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await CheckApiConnection();
        StartAutoRefresh();
    }

    private async Task LoadData()
    {
        var allDocs = await DocumentService.GetDocumentsAsync();
        UpdateDashboard(allDocs);
    }

    private async Task LoadDataInNewScope()
    {
        using var scope = ScopeFactory.CreateScope();
        var documentService = scope.ServiceProvider.GetRequiredService<IDocumentService>();
        var allDocs = await documentService.GetDocumentsAsync();
        UpdateDashboard(allDocs);
    }

    private void UpdateDashboard(List<BlazorApp2.Models.DTOs.DocumentListItemDto> allDocs)
    {
        var currentCount = allDocs.Count;
        if (lastDocumentCount > 0 && currentCount > lastDocumentCount)
        {
            var newDoc = allDocs.OrderByDescending(d => d.ReceivedAt).First();
            notification = $"Neues Dokument empfangen: {newDoc.FileName}";
        }
        lastDocumentCount = currentCount;
        
        receivedCount = allDocs.Count(d => d.Status == DocumentStatus.Received);
        pendingCount = allDocs.Count(d => d.Status == DocumentStatus.PendingReview || d.Status == DocumentStatus.Extracted);
        reviewedCount = allDocs.Count(d => d.Status == DocumentStatus.Reviewed);
        submittedCount = allDocs.Count(d => d.Status == DocumentStatus.Submitted);
        
        recentDocuments = allDocs.OrderByDescending(d => d.ReceivedAt).Take(5).ToList();
    }

    private void StartAutoRefresh()
    {
        if (autoRefreshEnabled)
        {
            refreshTimer = new System.Threading.Timer(async _ =>
            {
                await LoadDataInNewScope();
                await InvokeAsync(StateHasChanged);
            }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        }
    }

    private void OnAutoRefreshChanged()
    {
        if (autoRefreshEnabled)
        {
            StartAutoRefresh();
        }
        else
        {
            refreshTimer?.Dispose();
            refreshTimer = null;
        }
    }

    private async Task CheckApiConnection()
    {
        isCheckingApi = true;
        StateHasChanged();
        
        apiConnected = await DocumentService.CheckApiConnectionAsync();
        
        isCheckingApi = false;
        StateHasChanged();
    }

    private string GetStatusDisplayName(DocumentStatus status) => status switch
    {
        DocumentStatus.Received => "Empfangen",
        DocumentStatus.Processing => "In Bearbeitung",
        DocumentStatus.Extracted => "Extrahiert",
        DocumentStatus.PendingReview => "Prüfung ausstehend",
        DocumentStatus.Reviewed => "Geprüft",
        DocumentStatus.Submitted => "Übermittelt",
        DocumentStatus.Error => "Fehler",
        _ => status.ToString()
    };

    private string GetStatusBadgeClass(DocumentStatus status) => status switch
    {
        DocumentStatus.Received => "bg-info",
        DocumentStatus.Processing => "bg-warning text-dark",
        DocumentStatus.Extracted => "bg-primary",
        DocumentStatus.PendingReview => "bg-warning text-dark",
        DocumentStatus.Reviewed => "bg-success",
        DocumentStatus.Submitted => "bg-success",
        DocumentStatus.Error => "bg-danger",
        _ => "bg-secondary"
    };

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
