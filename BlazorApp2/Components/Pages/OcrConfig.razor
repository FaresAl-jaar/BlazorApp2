@page "/admin/ocr-config"
@using BlazorApp2.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject IOcrConfigService ConfigService
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Dokumenten-Analyse Konfiguration</PageTitle>

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="bi bi-gear-wide-connected me-2"></i>Analyse-Muster Konfiguration</h2>
            <p class="text-muted fw-bold">
                Konfigurieren Sie Erkennungsmuster und Keywords f√ºr die PDF-Datenextraktion.
                <br/>
                <small><i class="bi bi-folder me-1"></i>Pfad: <code>@configPath</code></small>
            </p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert @(isError ? "alert-danger" : "alert-success") alert-dismissible fade show">
            <i class="bi @(isError ? "bi-exclamation-circle" : "bi-check-circle") me-2"></i>@statusMessage
            <button type="button" class="btn-close" @onclick="() => statusMessage = null"></button>
        </div>
    }

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-code-square me-2"></i>JSON Editor</span>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" @onclick="FormatJson" title="JSON formatieren">
                            <i class="bi bi-text-indent-left"></i> Formatieren
                        </button>
                        <button class="btn btn-sm btn-outline-info me-2" @onclick="ValidateJson" title="JSON validieren">
                            <i class="bi bi-check2-square"></i> Validieren
                        </button>
                        <button class="btn btn-sm btn-primary" @onclick="SaveConfig" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-save me-1"></i>Speichern
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <textarea @bind="configJson" 
                              class="form-control font-monospace border-0" 
                              style="min-height: 600px; resize: vertical; font-size: 0.85rem;"
                              spellcheck="false"></textarea>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>Hilfe
                </div>
                <div class="card-body">
                    <h6>Struktur</h6>
                    <ul class="small">
                        <li><strong>patterns</strong> - Alle Regex-Pattern und Keywords</li>
                        <li><strong>validationRules</strong> - Logik-Regeln (bleiben im Code)</li>
                        <li><strong>languages</strong> - Unterstuetzte Sprachen</li>
                    </ul>
                    
                    <h6 class="mt-3">Sprachen hinzufuegen</h6>
                    <p class="small">
                        Um eine neue Sprache hinzuzufuegen, ergaenzen Sie ein neues Keyword-Objekt:
                    </p>
                    <pre class="bg-light p-2 small rounded">{ "lang": "hu", "value": "Sof?r" }</pre>
                    
                    <h6 class="mt-3">Regex testen</h6>
                    <p class="small">
                        Nutzen Sie <a href="https://regex101.com/" target="_blank">regex101.com</a> zum Testen.
                        Verwenden Sie <code>Python</code> als Flavor.
                    </p>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-header">
                    <i class="bi bi-translate me-2"></i>Aktive Sprachen
                </div>
                <div class="card-body">
                    @if (activeLanguages.Any())
                    {
                        @foreach (var lang in activeLanguages)
                        {
                            <span class="badge bg-primary me-1 mb-1">@GetLanguageName(lang)</span>
                        }
                    }
                    else
                    {
                        <span class="text-muted">Keine Sprachen konfiguriert</span>
                    }
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-clock-history me-2"></i>Aktionen
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" @onclick="ReloadConfig">
                        <i class="bi bi-arrow-clockwise me-1"></i>Neu laden
                    </button>
                    <button class="btn btn-outline-warning btn-sm w-100 mb-2" @onclick="ResetToDefault">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>Auf Standard zuruecksetzen
                    </button>
                    <button class="btn btn-outline-info btn-sm w-100" @onclick="DownloadConfig">
                        <i class="bi bi-download me-1"></i>Als Datei herunterladen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string configJson = "";
    private string configPath = "";
    private string? statusMessage;
    private bool isError;
    private bool isSaving;
    private List<string> activeLanguages = new();

    protected override async Task OnInitializedAsync()
    {
        configPath = ConfigService.GetConfigPath();
        await ReloadConfig();
    }

    private async Task ReloadConfig()
    {
        try
        {
            configJson = await ConfigService.GetConfigJsonAsync();
            ParseLanguages();
            statusMessage = null;
        }
        catch (Exception ex)
        {
            statusMessage = $"Fehler beim Laden: {ex.Message}";
            isError = true;
        }
    }

    private void ParseLanguages()
    {
        activeLanguages.Clear();
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(configJson);
            if (doc.RootElement.TryGetProperty("languages", out var langs))
            {
                foreach (var lang in langs.EnumerateArray())
                {
                    var val = lang.GetString();
                    if (!string.IsNullOrEmpty(val))
                        activeLanguages.Add(val);
                }
            }
        }
        catch { }
    }

    private async Task SaveConfig()
    {
        isSaving = true;
        statusMessage = null;
        
        try
        {
            await ConfigService.SaveConfigJsonAsync(configJson);
            statusMessage = "Konfiguration erfolgreich gespeichert!";
            isError = false;
            ParseLanguages();
        }
        catch (Exception ex)
        {
            statusMessage = $"Fehler beim Speichern: {ex.Message}";
            isError = true;
        }
        
        isSaving = false;
    }

    private void ValidateJson()
    {
        try
        {
            System.Text.Json.JsonDocument.Parse(configJson);
            statusMessage = "JSON ist gueltig!";
            isError = false;
        }
        catch (System.Text.Json.JsonException ex)
        {
            statusMessage = $"JSON ungueltig: {ex.Message}";
            isError = true;
        }
    }

    private void FormatJson()
    {
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(configJson);
            configJson = System.Text.Json.JsonSerializer.Serialize(doc, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
            statusMessage = "JSON formatiert!";
            isError = false;
        }
        catch (Exception ex)
        {
            statusMessage = $"Formatierung fehlgeschlagen: {ex.Message}";
            isError = true;
        }
    }

    private async Task DownloadConfig()
    {
        var fileName = $"ocr_config_{DateTime.Now:yyyyMMdd_HHmmss}.json";
        var bytes = System.Text.Encoding.UTF8.GetBytes(configJson);
        var base64 = Convert.ToBase64String(bytes);
        
        await JS.InvokeVoidAsync("eval", $@"
            var link = document.createElement('a');
            link.download = '{fileName}';
            link.href = 'data:application/json;base64,{base64}';
            link.click();
        ");
    }

    private async Task ResetToDefault()
    {
        try
        {
            isSaving = true;
            await ConfigService.ResetToDefaultAsync();
            await ReloadConfig();
            statusMessage = "Konfiguration wurde auf Standardwerte zurueckgesetzt.";
            isError = false;
        }
        catch (Exception ex)
        {
            statusMessage = $"Fehler beim Zuruecksetzen: {ex.Message}";
            isError = true;
        }
        finally
        {
            isSaving = false;
        }
    }

    private string GetLanguageName(string code) => code switch
    {
        "de" => "???? Deutsch",
        "pl" => "???? Polnisch",
        "hu" => "???? Ungarisch",
        "en" => "???? Englisch",
        "cz" => "???? Tschechisch",
        "sk" => "???? Slowakisch",
        _ => code.ToUpper()
    };
}
